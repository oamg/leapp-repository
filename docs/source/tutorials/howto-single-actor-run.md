# How to run a single Actor

During development or debugging of actors there may appear a need of running
single actor instead of the entire workflow, which can be time consuming.
However, since actor seems to be independent piece of code, there
are some dependencies inside a workflow, especially around consumed
messages and configuration which have to be resolved.

There are two approaches for running single actor execution.

## Run single actor with existing database

*leapp.db* is a file containing all information needed to run any actor on a system, including
messages and configurations. Usually all necessary environment for actors is set up by
first run of `leapp preupgrade` command. It is also possible to run on external
(i.e. transferred from other system) database file, however it requires proper handling of
contexts and database file to not overwrite what actually needs to be tested.

After the initial run of `leapp preupgrade`, running a single actor will work with any additional actions.
However, there are use cases, especially during debugging upgrade process, when the actor
needs to be run in a specific database environment (like a set of existing messages). Those
database environments are called context.
Every new run of `leapp` command creates another entry in the database. It creates
another row in execution table with specific ID, so each context can be easily tracked and
reproduced.
To determine which context `leapp` will run, there are two variables: `LEAPP_DEBUG_PRESERVE_CONTEXT`
and `LEAPP_EXECUTION_ID`. When the `LEAPP_DEBUG_PRESERVE_CONTEXT` is set to 1 and the environment has
`LEAPP_EXECUTION_ID` set, the `LEAPP_EXECUTION_ID` is not overwritten with snactor's execution ID.
This allows the developer to run actors in the same way as if the actor was run during the last leapp's
execution, thus, avoiding to rerun the entire upgrade process.

### Example

See list of executions using [leapp-inspector](https://leapp-repository.readthedocs.io/latest/tutorials/troubleshooting-debugging.html#troubleshooting-with-leapp-inspector) tool.

```shell
leapp-inspector --db path/to/leapp.db executions
```

```{note}
Make sure you are pointing to the right database.
```

Set variables:
```shell

export LEAPP_DEBUG_PRESERVE_CONTEXT=1
export LEAPP_EXECUTION_ID=0d4f830a-2922-4038-bea1-c0555f781af7
```

Run desired actors or the entire upgrade process safely now. Output will not be preserved as another context entry.

## Run single actor with minimal context

It is possible to run a single actor without proceeding with `leapp preupgrade` machinery.
This solution is based on a snactor tool. However, this solution requires a little more
understanding of Leapp project architecture.

As it is described in [article](https://leapp.readthedocs.io/en/stable/building-blocks-and-architecture.html#architecture-overview)
about workflow architecture, most of the actors are part of the produce/consume chain
of messages. While using this snactor method, all consumption needs of
desired actor needs to be satisfied.

Important step in this procedure is to be able to recreate the sequence of
actors to be run to fulfill a chain of dependencies, provide necessary variables
and use the `snactor` tool with proper options, like `--save-output` and `--print-output`.


### Hands-on example

Following example will be based on the `pci_devices_scanner` actor.
All actors (even those which are not depending on any message emitted by
other actors) depend on some initial default configuration.

Initial step is to set up environment variables which are necessary to generate
initial config.

Note that following vars are example ones, adjust them to your needs
depending on your system configuration:
```shell

export UPGRADE_PATH_FLAVOR=default
export PATH_TARGET_RELEASE=9.6
```

In the case of `IPUWorkflow`, this default config is generated by `ipu_workflow_config`
actor. To generate necessary config, run:

```shell
snactor run ipu_workflow_config --print-output --save-output
```

```{note}
Additional options for printing and in particular *saving* are necessary to
preserve output of this command.
```

Next steps depend on the sequence of actors needed by the desired actor. In the case of `pci_devices_scanner`
the actor which directly depends on is `load_device_driver_deprecation_data` actor. It needs to be run now.

```shell
snactor run load_device_driver_deprecation_data --print-output --actor-config IPUConfig
```

```{note}
Important step here is to point out what actor config needs to be used, `IPUConfig` in that case.
This parameter needs to be specified every time you want to run an actor.
```

Finally, the desired actor can be run:
```shell
snactor run pci_devices_scanner --print-output
```

General advice for such an issue is to start execution from the last (desired) actor and in a recursive way solving issues,
because the procedure explained here, may not be suitable for all cases. Tools for discovering actor's
dependencies are described in the following section.

## How to detect actor's dependencies and sequence

TBD