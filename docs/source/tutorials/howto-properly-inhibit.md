# How to properly inhibit the upgrade process
Before continuing, we recommend to first follow the TODO {external:doc}`framework tutorial on reporting<TODO>`.

## Why inhibit the upgrade process
A critical part of in-place upgrades are inhibtitors. Inhibitors are typically
used when the upgrade cannot safely continue, this can have multiple reasons:
- the upgrade is missing a required resource - for example it cannot figure
 out what repositories to use on the target system
- when the upgrade cannot continue without the risk of damaging the system -
for example a database needs to be migrated or becomes damaged or inaccessible
on the target system
- the source system is unsupported
- the target system would become unsupported after the upgrade - for example a
kernel driver might be supported by the source system but no the target system

## What is an inhibitor
An inhibitor is a {ref}`Report<building-blocks-and-architecture:report>` with
the {py:attr}`leapp.reporting.Groups.INHIBITOR` set. There is nothing else
special about inhibitors, the inhibition is done by a dedicated actor which
checks whether there are any reports produced before the `ReportsPhase` with
the group set and if so stops the upgrade.

```{important}
Any Report message produced **after** the Report phase will
**not** have inhibiting effect. The details mentioned in the Report messages
will be part of the report available to the user to review.
```

## Producing an inhibitor
Any actor can inhibit the upgrade process by producing a report and adding the
{py:attr}`leapp.reporting.Groups.INHIBITOR` to `leapp.reporting.Groups()`.
### Example Actor
```python
import platform

from leapp.actors import Actor
from leapp.reporting import Report, create_report
from leapp import reporting
from leapp.tags import ChecksPhaseTag, IPUWorkflowTag


class CheckSystemArch(Actor):
    """
    Check if system is running at a supported architecture. If no, inhibit the upgrade process.

    Base on collected system facts, verify if current architecture is supported, otherwise produces
    a message to inhibit upgrade process
    """

    name = 'check_system_arch'
    consumes = ()
    produces = (Report,)
    tags = (ChecksPhaseTag, IPUWorkflowTag)

    def process(self):
        if platform.machine() != 'x86_64':
            create_report([
                reporting.Title('Unsupported architecture'),
                reporting.Summary('Upgrade process is only supported on x86_64 systems.'),
                reporting.Severity(reporting.Severity.HIGH),
                reporting.Groups([reporting.Groups.INHIBITOR, reporting.Groups.SANITY]),  # note the INHIBITOR group
            ])
```

This is all that an actor needs to do in order to verify if some condition is
present on the system and inhibit the upgrade process based on that check.

## Tips and best practices on writing inhibitor reports
- Follow general best practices on writing reports - TODO link
- An inhibitor report should always be high severity - this is not imposed by
the framework, but a strict rule for in-place upgrades
- Do *NOT* inhibit on error - inhibitors are meant for expected problems with
the system or upgrade configuration the use needs to deal with before moving on
with the upgrade. They are not designed to be used for general failures. To
gracefully end the upgrade due to a failures, raise the
{py:class}`leapp.exception.StopActorExecutionError` exception.
- If possible and available, include remediation instructions.
- Carefully consider whether a report needs to be an inhibitor

## Details on inibition implementation

After all the system checks are executed by different actors, an existing actor
named
[VerifyCheckResults](https://github.com/oamg/leapp-repository/tree/master/repos/system_upgrade/common/actors/verifycheckresults)
is scheduled to run in the Leapp upgrade workflow. If some
{py:class}`~leapp.reporting.Report` message with the
{py:attr}`~leapp.reporting.Groups.INHIBITOR` group was generated by some
previous execution of another actor in any previous phase of the workflow, like
the sample one we just wrote, the actor request the framework to stop the
upgrade after the current phase using
{py:class}`leapp.exception.RequestStopAfterPhase`.
