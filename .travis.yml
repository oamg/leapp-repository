language: python
python: "2.7"
git:
  depth: false
jobs:
  include:
    - stage: unittests
      name: "Unit tests"
      env: CONTAINER=centos:7
      services:
        - docker
      install:
        - docker pull ${CONTAINER}
        - docker build -t leapp-tests -f utils/docker-tests/Dockerfile utils/docker-tests
      script:
        - docker run --rm -ti -v ${PWD}:/payload leapp-tests
    - stage: pr_cd
      name: "Deployment to COPR @leapp/leapp-pr-builds"
      before_install:
        - openssl aes-256-cbc -K $encrypted_2088d124a3c7_key -iv $encrypted_2088d124a3c7_iv -in .copr.enc -out ${HOME}/.config/copr -d
      install:
        - pip install copr-cli
        - pip install configparser
        - sudo apt-get install rpm
      env:
        COPR_REPO: "@leapp/leapp-pr-builds"
        COPR_REPO_TMP: "@leapp/leapp-tmp"
        COPR_CONFIG: "~/.config/copr"
      sudo: required
      script:
        - sudo ln -sf /bin/bash /bin/sh
        - command -v copr || sudo ln -sf $(command -v copr-cli) /bin/copr
        - make copr_build
stages:
  - name: unittests
  - name: pr_cd
    if: type == pull_request
